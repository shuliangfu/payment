# @dreamer/payment 测试报告

> 统一支付库测试报告

---

## 📊 测试概览

| 指标 | 数值 |
|------|------|
| 总测试数 | 111 |
| 通过 | 111 |
| 失败 | 0 |
| 跳过 | 0 |
| 通过率 | 100% |

---

## 🧪 测试结果

### 运行时间统计

| 运行时 | 执行时间 | 状态 |
|--------|----------|------|
| Deno 2.x | ~27s | ✅ 通过 |
| Bun 1.x | ~500ms | ✅ 通过 |

### 测试文件统计

| 文件 | 测试数 | 状态 |
|------|--------|------|
| mod.test.ts | 15 | ✅ |
| currency.test.ts | 20 | ✅ |
| reconciliation.test.ts | 15 | ✅ |
| crypto.test.ts | 22 | ✅ |
| subscription.test.ts | 12 | ✅ |
| web3.test.ts | 27 | ✅ |

---

## 🔬 功能测试详情

### 模块导出测试 (15 tests)

| 测试用例 | 状态 |
|----------|------|
| 应该导出所有适配器创建函数 | ✅ |
| 应该导出工厂函数 | ✅ |
| 应该导出货币转换相关 | ✅ |
| 应该导出对账相关 | ✅ |
| 应该导出日志器 | ✅ |
| getSupportedAdapters 应该返回所有支持的适配器 | ✅ |

#### Stripe 适配器

| 测试用例 | 状态 |
|----------|------|
| 应该能创建适配器实例 | ✅ |
| 应该验证配置 | ✅ |
| 应该返回客户端配置 | ✅ |

#### Web3 适配器

| 测试用例 | 状态 |
|----------|------|
| 应该能创建适配器实例 | ✅ |
| 应该验证地址配置 | ✅ |
| 应该返回客户端配置 | ✅ |
| 应该支持多个网络 | ✅ |

#### 工厂函数

| 测试用例 | 状态 |
|----------|------|
| 应该通过工厂函数创建适配器 | ✅ |
| 应该对无效适配器抛出错误 | ✅ |

---

### 货币转换测试 (20 tests)

#### 固定汇率提供者

| 测试用例 | 状态 |
|----------|------|
| 应该能创建固定汇率提供者 | ✅ |
| 应该能获取固定汇率 | ✅ |
| 应该能计算反向汇率 | ✅ |
| 应该对不存在的货币对返回 null | ✅ |
| 应该能批量获取汇率 | ✅ |

#### 货币转换器

| 测试用例 | 状态 |
|----------|------|
| 应该能创建转换器 | ✅ |
| 应该能使用便捷函数创建 | ✅ |
| 应该能转换货币 | ✅ |
| 相同货币应该返回相同金额 | ✅ |
| 应该缓存汇率 | ✅ |
| 应该能清除缓存 | ✅ |
| 应该能批量转换 | ✅ |
| 应该对无法获取汇率的情况返回错误 | ✅ |

#### 货币格式化

| 测试用例 | 状态 |
|----------|------|
| 应该正确格式化美元 | ✅ |
| 应该正确格式化人民币 | ✅ |
| 应该正确格式化欧元 | ✅ |
| 应该正确格式化日元（无小数） | ✅ |
| 应该对未知货币使用货币代码 | ✅ |

#### 货币常量

| 测试用例 | 状态 |
|----------|------|
| 应该包含常用货币 | ✅ |
| 应该包含正确的货币信息 | ✅ |

---

### 对账工具测试 (15 tests)

#### 内存交易存储

| 测试用例 | 状态 |
|----------|------|
| 应该能保存交易记录 | ✅ |
| 应该能批量保存交易记录 | ✅ |
| 应该能根据交易 ID 获取记录 | ✅ |
| 应该对不存在的交易 ID 返回 null | ✅ |
| 应该能根据订单 ID 获取记录 | ✅ |
| 应该能查询时间范围内的记录 | ✅ |
| 应该能按渠道查询记录 | ✅ |
| 应该能更新交易状态 | ✅ |
| 应该能统计交易 | ✅ |
| 应该能清空记录 | ✅ |

#### 对账器

| 测试用例 | 状态 |
|----------|------|
| 应该能创建对账器 | ✅ |
| 应该能使用便捷函数创建 | ✅ |
| 应该能执行对账（无远程数据） | ✅ |
| 应该能生成对账报告 | ✅ |
| 应该能导出 CSV | ✅ |

---

### 加密工具测试 (22 tests)

#### HMAC 签名

| 测试用例 | 状态 |
|----------|------|
| 应该能生成 HMAC-SHA256 签名 | ✅ |
| 相同数据和密钥应该生成相同签名 | ✅ |
| 不同数据应该生成不同签名 | ✅ |
| 不同密钥应该生成不同签名 | ✅ |

#### HMAC 验证

| 测试用例 | 状态 |
|----------|------|
| 应该验证正确的签名 | ✅ |
| 应该拒绝错误的签名 | ✅ |
| 应该拒绝错误的数据 | ✅ |

#### 恒定时间比较

| 测试用例 | 状态 |
|----------|------|
| 相同字符串应该返回 true | ✅ |
| 不同字符串应该返回 false | ✅ |
| 长度不同应该返回 false | ✅ |

#### Stripe Webhook 验证

| 测试用例 | 状态 |
|----------|------|
| 应该拒绝无效格式的签名 | ✅ |
| 应该拒绝过期的时间戳 | ✅ |
| 应该验证正确的签名 | ✅ |

#### 随机字符串生成

| 测试用例 | 状态 |
|----------|------|
| 应该生成指定长度的随机字符串 | ✅ |
| 默认生成 32 位字符串 | ✅ |
| 每次生成的字符串应该不同 | ✅ |
| 应该只包含字母数字字符 | ✅ |

#### 时间戳和日期格式化

| 测试用例 | 状态 |
|----------|------|
| 应该返回秒级时间戳 | ✅ |
| 应该返回当前时间附近的值 | ✅ |
| 应该格式化为 yyyy-MM-dd HH:mm:ss | ✅ |
| 应该正确补零 | ✅ |
| 默认使用当前时间 | ✅ |

---

### 订阅支付测试 (12 tests)

#### Stripe 订阅适配器

| 测试用例 | 状态 |
|----------|------|
| 应该支持订阅功能 | ✅ |
| createPlan 应该返回正确的结构 | ✅ |
| createSubscription 应该返回正确的结构 | ✅ |
| cancelSubscription 应该返回正确的结构 | ✅ |
| getSubscription 应该返回正确的结构 | ✅ |
| listSubscriptions 应该返回正确的结构 | ✅ |

#### PayPal 订阅适配器

| 测试用例 | 状态 |
|----------|------|
| 应该支持订阅功能 | ✅ |
| createPlan 方法应该存在 | ✅ |
| createSubscription 方法应该存在 | ✅ |
| listSubscriptions 应该返回不支持提示 | ✅ |

#### 订阅计划类型

| 测试用例 | 状态 |
|----------|------|
| 应该支持多种订阅周期 | ✅ |
| 应该支持订阅状态 | ✅ |

---

### Web3 支付测试 (24 tests)

#### 适配器基础功能

| 测试用例 | 状态 |
|----------|------|
| 适配器应该成功创建 | ✅ |
| validateConfig 应该返回 true | ✅ |

#### 客户端配置测试

| 测试用例 | 状态 |
|----------|------|
| 应该返回正确的基本配置 | ✅ |
| 应该返回正确的 chainId | ✅ |
| 应该返回正确的 RPC 端点 | ✅ |
| 应该返回正确的合约配置 | ✅ |

#### 支付创建测试

| 测试用例 | 状态 |
|----------|------|
| 应该生成 ETH 支付信息 | ✅ |
| 应该生成 USDT 支付信息 | ✅ |

#### 查询测试

| 测试用例 | 状态 |
|----------|------|
| 查询不存在的交易应该返回失败 | ✅ |

#### 二维码支付 - paymentUri 测试

| 测试用例 | 状态 |
|----------|------|
| ETH 支付应该生成正确的 paymentUri | ✅ |
| USDT 支付应该生成正确的 paymentUri | ✅ |

#### generatePaymentUri 工具函数测试

| 测试用例 | 状态 |
|----------|------|
| 应该生成正确的原生代币支付链接 | ✅ |
| 应该生成正确的 ERC-20 代币支付链接 | ✅ |
| 应该支持不同的 chainId | ✅ |
| 应该支持任意金额 | ✅ |

#### createTransferWatcher 监听器测试

| 测试用例 | 状态 |
|----------|------|
| 应该成功创建监听器 | ✅ |
| 初始状态应该是未运行 | ✅ |
| 应该能启动和停止监听器（轮询模式） | ✅ |
| 应该能注册和移除回调 | ✅ |
| 应该支持代币配置 | ✅ |
| 应该支持 WebSocket 配置 | ✅ |
| 应该支持强制轮询模式 | ✅ |
| 应该支持更多事件类型 | ✅ |
| 手动检查应该返回空数组（首次运行） | ✅ |

#### RPC 连接测试（需要 Anvil 运行）

| 测试用例 | 状态 |
|----------|------|
| 应该能连接到本地 Anvil 节点 | ✅ |
| 应该能获取账户余额 | ✅ |
| 应该能读取订阅合约 owner | ✅ |

---

## 🌍 跨运行时兼容性

| 功能 | Deno | Bun |
|------|------|-----|
| 适配器创建 | ✅ | ✅ |
| 配置验证 | ✅ | ✅ |
| 货币转换 | ✅ | ✅ |
| 汇率缓存 | ✅ | ✅ |
| 交易存储 | ✅ | ✅ |
| 对账功能 | ✅ | ✅ |
| 报告生成 | ✅ | ✅ |
| CSV 导出 | ✅ | ✅ |
| 订阅支付 | ✅ | ✅ |
| Web3 支付 | ✅ | ✅ |

---

## 🚀 性能统计

| 测试类别 | Deno 平均耗时 | Bun 平均耗时 |
|----------|--------------|--------------|
| 适配器创建 | <1ms | <1ms |
| 配置验证 | <1ms | <1ms |
| 货币转换 | ~17ms | ~1ms |
| 对账操作 | ~33ms | ~1ms |

---

## 📝 测试环境

- **Deno**: 2.x
- **Bun**: 1.x
- **操作系统**: macOS/Linux
- **测试框架**: @dreamer/test

---

## ⚠️ 已知限制

1. **支付 API 测试**: 由于需要真实的支付平台凭据，实际支付 API 调用未在单元测试中覆盖
2. **Web3 网络测试**: 区块链 RPC 调用需要网络连接，部分测试仅验证配置
3. **远程汇率测试**: 外部汇率 API 测试需要有效的 API Key

---

## ✅ 测试覆盖说明

### 已覆盖

- [x] 所有 8 个支付适配器创建函数
- [x] 工厂函数和适配器管理
- [x] 货币转换器核心功能
- [x] 固定汇率提供者
- [x] 汇率缓存机制
- [x] 货币格式化
- [x] 内存交易存储
- [x] 对账器核心功能
- [x] 报告和 CSV 导出
- [x] Stripe/PayPal 订阅支付接口
- [x] Web3 支付适配器（本地 Anvil 测试）
- [x] Web3 合约配置和 RPC 连接
- [x] Web3 二维码支付（EIP-681 paymentUri）
- [x] Web3 链上转账监听器（createTransferWatcher）

### 需要集成测试

- [ ] Stripe 实际支付流程
- [ ] PayPal 实际支付流程
- [ ] 支付宝/微信支付回调验签
- [ ] Web3 链上交易验证（主网/测试网）
- [ ] 远程汇率 API 调用
- [ ] Stripe 交易获取器

---

## 📅 测试时间

最后测试时间: 2026-01-31

---

Made with ❤️ by Dreamer Team
